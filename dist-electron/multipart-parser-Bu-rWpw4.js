"use strict";Object.defineProperty(exports,Symbol.toStringTag,{value:"Module"});const F=require("./main-BOOs3PTk.js");let D=0;const t={START_BOUNDARY:D++,HEADER_FIELD_START:D++,HEADER_FIELD:D++,HEADER_VALUE_START:D++,HEADER_VALUE:D++,HEADER_VALUE_ALMOST_DONE:D++,HEADERS_ALMOST_DONE:D++,PART_DATA_START:D++,PART_DATA:D++,END:D++};let k=1;const _={PART_BOUNDARY:k,LAST_BOUNDARY:k*=2},p=10,O=13,U=32,g=45,w=58,B=97,V=122,Y=u=>u|32,R=()=>{};class x{constructor(o){this.index=0,this.flags=0,this.onHeaderEnd=R,this.onHeaderField=R,this.onHeadersEnd=R,this.onHeaderValue=R,this.onPartBegin=R,this.onPartData=R,this.onPartEnd=R,this.boundaryChars={},o=`\r
--`+o;const n=new Uint8Array(o.length);for(let r=0;r<o.length;r++)n[r]=o.charCodeAt(r),this.boundaryChars[n[r]]=!0;this.boundary=n,this.lookbehind=new Uint8Array(this.boundary.length+8),this.state=t.START_BOUNDARY}write(o){let n=0;const r=o.length;let E=this.index,{lookbehind:A,boundary:d,boundaryChars:H,index:e,state:i,flags:l}=this;const b=this.boundary.length,m=b-1,y=o.length;let a,S;const h=c=>{this[c+"Mark"]=n},s=c=>{delete this[c+"Mark"]},f=(c,P,T,N)=>{(P===void 0||P!==T)&&this[c](N&&N.subarray(P,T))},L=(c,P)=>{const T=c+"Mark";T in this&&(P?(f(c,this[T],n,o),delete this[T]):(f(c,this[T],o.length,o),this[T]=0))};for(n=0;n<r;n++)switch(a=o[n],i){case t.START_BOUNDARY:if(e===d.length-2){if(a===g)l|=_.LAST_BOUNDARY;else if(a!==O)return;e++;break}else if(e-1===d.length-2){if(l&_.LAST_BOUNDARY&&a===g)i=t.END,l=0;else if(!(l&_.LAST_BOUNDARY)&&a===p)e=0,f("onPartBegin"),i=t.HEADER_FIELD_START;else return;break}a!==d[e+2]&&(e=-2),a===d[e+2]&&e++;break;case t.HEADER_FIELD_START:i=t.HEADER_FIELD,h("onHeaderField"),e=0;case t.HEADER_FIELD:if(a===O){s("onHeaderField"),i=t.HEADERS_ALMOST_DONE;break}if(e++,a===g)break;if(a===w){if(e===1)return;L("onHeaderField",!0),i=t.HEADER_VALUE_START;break}if(S=Y(a),S<B||S>V)return;break;case t.HEADER_VALUE_START:if(a===U)break;h("onHeaderValue"),i=t.HEADER_VALUE;case t.HEADER_VALUE:a===O&&(L("onHeaderValue",!0),f("onHeaderEnd"),i=t.HEADER_VALUE_ALMOST_DONE);break;case t.HEADER_VALUE_ALMOST_DONE:if(a!==p)return;i=t.HEADER_FIELD_START;break;case t.HEADERS_ALMOST_DONE:if(a!==p)return;f("onHeadersEnd"),i=t.PART_DATA_START;break;case t.PART_DATA_START:i=t.PART_DATA,h("onPartData");case t.PART_DATA:if(E=e,e===0){for(n+=m;n<y&&!(o[n]in H);)n+=b;n-=m,a=o[n]}if(e<d.length)d[e]===a?(e===0&&L("onPartData",!0),e++):e=0;else if(e===d.length)e++,a===O?l|=_.PART_BOUNDARY:a===g?l|=_.LAST_BOUNDARY:e=0;else if(e-1===d.length)if(l&_.PART_BOUNDARY){if(e=0,a===p){l&=~_.PART_BOUNDARY,f("onPartEnd"),f("onPartBegin"),i=t.HEADER_FIELD_START;break}}else l&_.LAST_BOUNDARY&&a===g?(f("onPartEnd"),i=t.END,l=0):e=0;if(e>0)A[e-1]=a;else if(E>0){const c=new Uint8Array(A.buffer,A.byteOffset,A.byteLength);f("onPartData",0,E,c),E=0,h("onPartData"),n--}break;case t.END:break;default:throw new Error(`Unexpected state entered: ${i}`)}L("onHeaderField"),L("onHeaderValue"),L("onPartData"),this.index=e,this.state=i,this.flags=l}end(){if(this.state===t.HEADER_FIELD_START&&this.index===0||this.state===t.PART_DATA&&this.index===this.boundary.length)this.onPartEnd();else if(this.state!==t.END)throw new Error("MultipartParser.end(): stream ended unexpectedly")}}function C(u){const o=u.match(/\bfilename=("(.*?)"|([^()<>@,;:\\"/[\]?={}\s\t]+))($|;\s)/i);if(!o)return;const n=o[2]||o[3]||"";let r=n.slice(n.lastIndexOf("\\")+1);return r=r.replace(/%22/g,'"'),r=r.replace(/&#(\d{4});/g,(E,A)=>String.fromCharCode(A)),r}async function M(u,o){if(!/multipart/i.test(o))throw new TypeError("Failed to fetch");const n=o.match(/boundary=(?:"([^"]+)"|([^;]+))/i);if(!n)throw new TypeError("no or bad content-type header, no multipart boundary");const r=new x(n[1]||n[2]);let E,A,d,H,e,i;const l=[],b=new F.FormData,m=s=>{d+=h.decode(s,{stream:!0})},y=s=>{l.push(s)},a=()=>{const s=new F.File(l,i,{type:e});b.append(H,s)},S=()=>{b.append(H,d)},h=new TextDecoder("utf-8");h.decode(),r.onPartBegin=function(){r.onPartData=m,r.onPartEnd=S,E="",A="",d="",H="",e="",i=null,l.length=0},r.onHeaderField=function(s){E+=h.decode(s,{stream:!0})},r.onHeaderValue=function(s){A+=h.decode(s,{stream:!0})},r.onHeaderEnd=function(){if(A+=h.decode(),E=E.toLowerCase(),E==="content-disposition"){const s=A.match(/\bname=("([^"]*)"|([^()<>@,;:\\"/[\]?={}\s\t]+))/i);s&&(H=s[2]||s[3]||""),i=C(A),i&&(r.onPartData=y,r.onPartEnd=a)}else E==="content-type"&&(e=A);A="",E=""};for await(const s of u)r.write(s);return r.end(),b}exports.toFormData=M;
